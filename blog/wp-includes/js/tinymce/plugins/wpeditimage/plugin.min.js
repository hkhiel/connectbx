tinymce.PluginManager.add("wpeditimage",function(e){function t(t){return!(!e.dom.getAttrib(t,"data-mce-placeholder")&&!e.dom.getAttrib(t,"data-mce-object"))}function n(t){var n=e.$(t).parents("[contenteditable]");return n&&"false"===n.attr("contenteditable")}function a(t){return t.replace(/(?:<p>)?\[(?:wp_)?caption([^\]]+)\]([\s\S]+?)\[\/(?:wp_)?caption\](?:<\/p>)?/g,function(t,n,a){var i,o,r,c,d,l;return(i=n.match(/id=['"]([^'"]*)['"] ?/))&&(n=n.replace(i[0],"")),(o=n.match(/align=['"]([^'"]*)['"] ?/))&&(n=n.replace(o[0],"")),(r=n.match(/class=['"]([^'"]*)['"] ?/))&&(n=n.replace(r[0],"")),(l=n.match(/width=['"]([0-9]*)['"] ?/))&&(n=n.replace(l[0],"")),a=u(a),(d=a.match(/((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)([\s\S]*)/i))&&d[2]?(c=u(d[2]),d=u(d[1])):(c=u(n).replace(/caption=['"]/,"").replace(/['"]$/,""),d=a),i=i&&i[1]?i[1].replace(/[<>&]+/g,""):"",o=o&&o[1]?o[1]:"alignnone",r=r&&r[1]?" "+r[1].replace(/[<>&]+/g,""):"",!l&&d&&(l=d.match(/width=['"]([0-9]*)['"]/)),l&&l[1]&&(l=l[1]),l&&c?(l=parseInt(l,10),e.getParam("wpeditimage_html5_captions")||(l+=10),'<div class="mceTemp"><dl id="'+i+'" class="wp-caption '+o+r+'" style="width: '+l+'px"><dt class="wp-caption-dt">'+d+'</dt><dd class="wp-caption-dd">'+c+"</dd></dl></div>"):a})}function i(e){return e.replace(/(?:<div [^>]+mceTemp[^>]+>)?\s*(<dl [^>]+wp-caption[^>]+>[\s\S]+?<\/dl>)\s*(?:<\/div>)?/g,function(e,t){var n="";return-1===t.indexOf("<img ")||-1!==t.indexOf("</p>")?t.replace(/<d[ldt]( [^>]+)?>/g,"").replace(/<\/d[ldt]>/g,""):(-1===(n=t.replace(/\s*<dl ([^>]+)>\s*<dt [^>]+>([\s\S]+?)<\/dt>\s*<dd [^>]+>([\s\S]*?)<\/dd>\s*<\/dl>\s*/gi,function(e,t,n,a){var i,o,r,c;return c=n.match(/width="([0-9]*)"/),c=c&&c[1]?c[1]:"",o=t.match(/class="([^"]*)"/),o=o&&o[1]?o[1]:"",r=o.match(/align[a-z]+/i)||"alignnone",c&&a?(i=t.match(/id="([^"]*)"/),i=i&&i[1]?i[1]:"",(o=o.replace(/wp-caption ?|align[a-z]+ ?/gi,""))&&(o=' class="'+o+'"'),a=a.replace(/\r\n|\r/g,"\n").replace(/<[a-zA-Z0-9]+( [^<>]+)?>/g,function(e){return e.replace(/[\r\n\t]+/," ")}),a=a.replace(/\s*\n\s*/g,"<br />"),'[caption id="'+i+'" align="'+r+'" width="'+c+'"'+o+"]"+n+" "+a+"[/caption]"):("alignnone"!==r[0]&&(n=n.replace(/><img/,' class="'+r[0]+'"><img')),n)})).indexOf("[caption")&&(n=t.replace(/[\s\S]*?((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)(<p>[\s\S]*<\/p>)?[\s\S]*/gi,"<p>$1</p>$2")),n)})}function o(e){return e&&!(!e.textContent&&!e.innerText)}function r(t){return!t||-1===t.indexOf("<")&&-1===t.indexOf(">")?t:(s||(s=new tinymce.html.Serializer({},e.schema)),s.serialize(e.parser.parse(t,{forced_root_block:!1})))}function c(t){var n,a,i;"undefined"!=typeof wp&&wp.media?(i=function(t){var n,a,i,o,r,c,d,l,s=[],p=e.dom,m=/^\d+$/;return i={attachment_id:!1,size:"custom",caption:"",align:"none",extraClasses:"",link:!1,linkUrl:"",linkClassName:"",linkTargetBlank:!1,linkRel:"",title:""},i.url=p.getAttrib(t,"src"),i.alt=p.getAttrib(t,"alt"),i.title=p.getAttrib(t,"title"),d=p.getAttrib(t,"width"),l=p.getAttrib(t,"height"),(!m.test(d)||parseInt(d,10)<1)&&(d=t.naturalWidth||t.width),(!m.test(l)||parseInt(l,10)<1)&&(l=t.naturalHeight||t.height),i.customWidth=i.width=d,i.customHeight=i.height=l,n=tinymce.explode(t.className," "),a=[],tinymce.each(n,function(e){/^wp-image/.test(e)?i.attachment_id=parseInt(e.replace("wp-image-",""),10):/^align/.test(e)?i.align=e.replace("align",""):/^size/.test(e)?i.size=e.replace("size-",""):a.push(e)}),i.extraClasses=a.join(" "),(o=p.getParents(t,".wp-caption")).length&&(n=(o=o[0]).className.split(" "),tinymce.each(n,function(e){/^align/.test(e)?i.align=e.replace("align",""):e&&"wp-caption"!==e&&s.push(e)}),i.captionClassName=s.join(" "),(r=p.select("dd.wp-caption-dd",o)).length&&(r=r[0],i.caption=e.serializer.serialize(r).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,""))),t.parentNode&&"A"===t.parentNode.nodeName&&(c=t.parentNode,i.linkUrl=p.getAttrib(c,"href"),i.linkTargetBlank="_blank"===p.getAttrib(c,"target"),i.linkRel=p.getAttrib(c,"rel"),i.linkClassName=c.className),i}(t),wp.media.events.trigger("editor:image-edit",{editor:e,metadata:i,image:t}),n=wp.media({frame:"image",state:"image-details",metadata:i}),wp.media.events.trigger("editor:frame-create",{frame:n}),a=function(a){e.focus(),e.undoManager.transact(function(){!function(t,n){var a,i,c,d,l,s,p,m,g,u,h,f,w,N,v,_,b,C,y=e.dom;(a=tinymce.explode(n.extraClasses," "))||(a=[]),n.caption||a.push("align"+n.align),n.attachment_id&&(a.push("wp-image-"+n.attachment_id),n.size&&"custom"!==n.size&&a.push("size-"+n.size)),N=n.width,v=n.height,"custom"===n.size&&(N=n.customWidth,v=n.customHeight),f={src:n.url,width:N||null,height:v||null,title:n.title||null,class:a.join(" ")||null},y.setAttribs(t,f),e.$(t).attr("alt",n.alt||""),w={href:n.linkUrl,rel:n.linkRel||null,target:n.linkTargetBlank?"_blank":null,class:n.linkClassName||null},t.parentNode&&"A"===t.parentNode.nodeName&&!o(t.parentNode)?n.linkUrl?y.setAttribs(t.parentNode,w):y.remove(t.parentNode,!0):n.linkUrl&&((p=y.getParent(t,"a"))&&y.insertAfter(t,p),p=y.create("a",w),t.parentNode.insertBefore(p,t),p.appendChild(t)),m=e.dom.getParent(t,".mceTemp"),c=t.parentNode&&"A"===t.parentNode.nodeName&&!o(t.parentNode)?t.parentNode:t,n.caption?(n.caption=r(n.caption),h=n.attachment_id?"attachment_"+n.attachment_id:null,i="wp-caption align"+(n.align||"none"),n.captionClassName&&(i+=" "+n.captionClassName.replace(/[<>&]+/g,"")),e.getParam("wpeditimage_html5_captions")||(N=parseInt(N,10),N+=10),m?((u=y.select("dl.wp-caption",m)).length&&y.setAttribs(u,{id:h,class:i,style:"width: "+N+"px"}),(g=y.select(".wp-caption-dd",m)).length&&y.setHTML(g[0],n.caption)):(d="<dl "+(h=h?'id="'+h+'" ':"")+'class="'+i+'" style="width: '+N+'px"><dt class="wp-caption-dt"></dt><dd class="wp-caption-dd">'+n.caption+"</dd></dl>",s=y.create("div",{class:"mceTemp"},d),(l=y.getParent(c,"p"))?l.parentNode.insertBefore(s,l):c.parentNode.insertBefore(s,c),e.$(s).find("dt.wp-caption-dt").append(c),l&&y.isEmpty(l)&&y.remove(l))):m&&(l=y.create("p"),m.parentNode.insertBefore(l,m),l.appendChild(c),y.remove(m)),b=(_=e.$(t)).attr("srcset"),C=_.attr("src"),b&&C&&(C=C.replace(/[?#].*/,""),-1===b.indexOf(C)&&_.attr("srcset",null).attr("sizes",null)),wp.media.events&&wp.media.events.trigger("editor:image-update",{editor:e,metadata:n,image:t}),e.nodeChanged()}(t,a)}),n.detach()},n.state("image-details").on("update",a),n.state("replace-image").on("replace",a),n.on("close",function(){e.focus(),n.detach()}),n.open()):e.execCommand("mceImage")}function d(t){var n=e.dom.getParent(t,"div.mceTemp");n||"IMG"!==t.nodeName||(n=e.dom.getParent(t,"a")),n?(n.nextSibling?e.selection.select(n.nextSibling):n.previousSibling?e.selection.select(n.previousSibling):e.selection.select(n.parentNode),e.selection.collapse(!0),e.dom.remove(n)):e.dom.remove(t),e.nodeChanged(),e.undoManager.add()}var l,s,p,m,g=tinymce.each,u=tinymce.trim,h=tinymce.Env.iOS;return e.addButton("wp_img_remove",{tooltip:"Remove",icon:"dashicon dashicons-no",onclick:function(){d(e.selection.getNode())}}),e.addButton("wp_img_edit",{tooltip:"Edit ",icon:"dashicon dashicons-edit",onclick:function(){c(e.selection.getNode())}}),g({alignleft:"Align left",aligncenter:"Align center",alignright:"Align right",alignnone:"No alignment"},function(t,n){var a=n.slice(5);e.addButton("wp_img_"+n,{tooltip:t,icon:"dashicon dashicons-align-"+a,cmd:"alignnone"===n?"wpAlignNone":"Justify"+a.slice(0,1).toUpperCase()+a.slice(1),onPostRender:function(){var t=this;e.on("NodeChange",function(a){var i;"IMG"===a.element.nodeName&&(i=e.dom.getParent(a.element,".wp-caption")||a.element,"alignnone"===n?t.active(!/\balign(left|center|right)\b/.test(i.className)):t.active(e.dom.hasClass(i,n)))})}})}),e.once("preinit",function(){e.wp&&e.wp._createToolbar&&(l=e.wp._createToolbar(["wp_img_alignleft","wp_img_aligncenter","wp_img_alignright","wp_img_alignnone","wp_img_edit","wp_img_remove"]))}),e.on("wptoolbar",function(e){"IMG"!==e.element.nodeName||t(e.element)||(e.toolbar=l)}),h&&e.on("init",function(){e.on("touchstart",function(e){"IMG"!==e.target.nodeName||n(e.target)||(p=!0)}),e.dom.bind(e.getDoc(),"touchmove",function(){p=!1}),e.on("touchend",function(t){if(p&&"IMG"===t.target.nodeName&&!n(t.target)){var a=t.target;p=!1,window.setTimeout(function(){e.selection.select(a),e.nodeChanged()},100)}else l&&l.hide()})}),e.on("init",function(){var t=e.dom,n=e.getParam("wpeditimage_html5_captions")?"html5-captions":"html4-captions";t.addClass(e.getBody(),n),e.on("wpLoadImageForm",function(t){if(!e.getParam("wpeditimage_disable_captions")){t.data.splice(t.data.length-1,0,{type:"textbox",flex:1,name:"wpcaption",minHeight:60,multiline:!0,scroll:!0,label:"Image caption"})}}),e.on("wpNewImageRefresh",function(e){var n,a;(n=t.getParent(e.node,"dl.wp-caption"))&&(n.style.width||(a=(a=parseInt(e.node.clientWidth,10)+10)?a+"px":"50%",t.setStyle(n,"width",a)))}),e.on("wpImageFormSubmit",function(n){var a,i,o,c,d=n.imgData.data,l=n.imgData.node,s=n.imgData.wpcaption,p="",m="",g="",u=null;d.id="__wp-temp-img-id",n.imgData.cancel=!0,d.style||(d.style=null),d.src?(s&&(s=r(s=(s=s.replace(/\r\n|\r/g,"\n").replace(/<\/?[a-zA-Z0-9]+( [^<>]+)?>/g,function(e){return e.replace(/[\r\n\t]+/," ")})).replace(/(<br[^>]*>)\s*\n\s*/g,"$1").replace(/\s*\n\s*/g,"<br />"))),l?(u=l.id||null,t.setAttribs(l,d),a=t.getParent(l,"dl.wp-caption"),s?a?(i=t.select("dd.wp-caption-dd",a)[0])&&(i.innerHTML=s):(l.className&&(p=l.className.match(/wp-image-([0-9]+)/),m=l.className.match(/align(left|right|center|none)/)),m?(m=m[0],l.className=l.className.replace(/align(left|right|center|none)/g,"")):m="alignnone",m=' class="wp-caption '+m+'"',p&&(p=' id="attachment_'+p[1]+'"'),(g=d.width||l.clientWidth)&&(g=parseInt(g,10),e.getParam("wpeditimage_html5_captions")||(g+=10),g=' style="width: '+g+'px"'),o=l.parentNode&&"A"===l.parentNode.nodeName?l.parentNode:l,c="<dl "+p+m+g+'><dt class="wp-caption-dt"></dt><dd class="wp-caption-dd">'+s+"</dd></dl>",a=t.create("div",{class:"mceTemp"},c),(i=t.getParent(o,"p"))?i.parentNode.insertBefore(a,i):o.parentNode.insertBefore(a,o),e.$(a).find("dt.wp-caption-dt").append(o),i&&t.isEmpty(i)&&t.remove(i)):a&&(c="A"===l.parentNode.nodeName?t.getOuterHTML(l.parentNode):t.getOuterHTML(l),i=t.create("p",{},c),t.insertAfter(i,a.parentNode),e.selection.select(i),e.nodeChanged(),t.remove(a.parentNode))):(c=t.createHTML("img",d),s?(o=e.selection.getNode(),d.width&&(g=parseInt(d.width,10),e.getParam("wpeditimage_html5_captions")||(g+=10),g=' style="width: '+g+'px"'),c='<dl class="wp-caption alignnone"'+g+'><dt class="wp-caption-dt">'+c+'</dt><dd class="wp-caption-dd">'+s+"</dd></dl>",(i="P"===o.nodeName?o:t.getParent(o,"p"))&&"P"===i.nodeName?(a=t.create("div",{class:"mceTemp"},c),i.parentNode.insertBefore(a,i),e.selection.select(a),e.nodeChanged(),t.isEmpty(i)&&t.remove(i)):e.selection.setContent('<div class="mceTemp">'+c+"</div>")):e.selection.setContent(c)),l=t.get("__wp-temp-img-id"),t.setAttrib(l,"id",u||null),n.imgData.node=l):l&&((a=t.getParent(l,"div.mceTemp"))?t.remove(a):"A"===l.parentNode.nodeName?t.remove(l.parentNode):t.remove(l),e.nodeChanged())}),e.on("wpLoadImageData",function(n){var a,i=n.imgData.data,o=n.imgData.node;(a=t.getParent(o,"dl.wp-caption"))&&(a=t.select("dd.wp-caption-dd",a)[0])&&(i.wpcaption=e.serializer.serialize(a).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,""))}),tinymce.Env.ie&&tinymce.Env.ie>10&&t.bind(e.getBody(),"mscontrolselect",function(n){"IMG"===n.target.nodeName&&t.getParent(n.target,".wp-caption")?e.getBody().focus():"DL"===n.target.nodeName&&t.hasClass(n.target,"wp-caption")&&n.target.focus()})}),e.on("ObjectResized",function(t){var n=t.target;"IMG"===n.nodeName&&e.undoManager.transact(function(){var a,i,o=e.dom;n.className=n.className.replace(/\bsize-[^ ]+/,""),(a=o.getParent(n,".wp-caption"))&&(i=t.width||o.getAttrib(n,"width"))&&(i=parseInt(i,10),e.getParam("wpeditimage_html5_captions")||(i+=10),o.setStyle(a,"width",i+"px"))})}),e.on("pastePostProcess",function(t){e.dom.getParent(e.selection.getNode(),"dd.wp-caption-dd")&&(e.$("img, audio, video, object, embed, iframe, script, style",t.node).remove(),e.$("*",t.node).each(function(t,n){e.dom.isBlock(n)&&(tinymce.trim(n.textContent||n.innerText)?(e.dom.insertAfter(e.dom.create("br"),n),e.dom.remove(n,!0)):e.dom.remove(n))}),e.$("br",t.node).each(function(t,n){n.nextSibling&&"BR"!==n.nextSibling.nodeName&&n.previousSibling&&"BR"!==n.previousSibling.nodeName||e.dom.remove(n)}),m=!0)}),e.on("BeforeExecCommand",function(t){var n,a,i,o,r,c,d=t.command,s=e.dom;if("mceInsertContent"===d||"Indent"===d||"Outdent"===d){if(n=e.selection.getNode(),c=s.getParent(n,"div.mceTemp")){if("mceInsertContent"!==d)return t.preventDefault(),t.stopImmediatePropagation(),!1;if(m)return void(m=!1);a=s.create("p"),s.insertAfter(a,c),e.selection.setCursorLocation(a,0),"IMG"===n.nodeName&&e.$(c).remove(),e.nodeChanged()}}else if("JustifyLeft"===d||"JustifyRight"===d||"JustifyCenter"===d||"wpAlignNone"===d){if(n=e.selection.getNode(),o="align"+d.slice(7).toLowerCase(),i=e.dom.getParent(n,".wp-caption"),"IMG"!==n.nodeName&&!i)return;n=i||n,r=e.dom.hasClass(n,o)?" alignnone":" "+o,n.className=u(n.className.replace(/ ?align(left|center|right|none)/g,"")+r),e.nodeChanged(),t.preventDefault(),l&&l.reposition(),e.fire("ExecCommand",{command:d,ui:t.ui,value:t.value})}}),e.on("keydown",function(t){var n,a,i,o,r=e.selection,c=t.keyCode,l=e.dom,s=tinymce.util.VK;if(c===s.ENTER)n=r.getNode(),(a=l.getParent(n,"div.mceTemp"))&&(l.events.cancel(t),tinymce.each(l.select("dt, dd",a),function(e){l.isEmpty(e)&&l.remove(e)}),o=tinymce.Env.ie&&tinymce.Env.ie<11?"":'<br data-mce-bogus="1" />',i=l.create("p",null,o),"DD"===n.nodeName?l.insertAfter(i,a):a.parentNode.insertBefore(i,a),e.nodeChanged(),r.setCursorLocation(i,0));else if((c===s.DELETE||c===s.BACKSPACE)&&("DIV"===(n=r.getNode()).nodeName&&l.hasClass(n,"mceTemp")?a=n:"IMG"!==n.nodeName&&"DT"!==n.nodeName&&"A"!==n.nodeName||(a=l.getParent(n,"div.mceTemp")),a))return l.events.cancel(t),d(n),!1}),tinymce.Env.gecko&&e.on("undo redo",function(){"IMG"===e.selection.getNode().nodeName&&e.selection.collapse()}),e.wpSetImgCaption=function(e){return a(e)},e.wpGetImgCaption=function(e){return i(e)},e.on("beforeGetContent",function(t){"raw"!==t.format&&e.$('img[id="__wp-temp-img-id"]').attr("id",null)}),e.on("BeforeSetContent",function(t){"raw"!==t.format&&(t.content=e.wpSetImgCaption(t.content))}),e.on("PostProcess",function(t){t.get&&(t.content=e.wpGetImgCaption(t.content))}),function(){var t;e.on("dragstart",function(){var n=e.selection.getNode();"IMG"===n.nodeName&&((t=e.dom.getParent(n,".mceTemp"))||"A"!==n.parentNode.nodeName||o(n.parentNode)||(t=n.parentNode))}),e.on("drop",function(n){var a=e.dom,i=tinymce.dom.RangeUtils.getCaretRangeFromPoint(n.clientX,n.clientY,e.getDoc());i&&a.getParent(i.startContainer,".mceTemp")?n.preventDefault():t&&(n.preventDefault(),e.undoManager.transact(function(){i&&e.selection.setRng(i),e.selection.setNode(t),a.remove(t)})),t=null})}(),e.wp=e.wp||{},e.wp.isPlaceholder=t,{_do_shcode:a,_get_shcode:i}});